var ft=Object.create;var{getPrototypeOf:ht,defineProperty:L,getOwnPropertyNames:ut}=Object;var wt=Object.prototype.hasOwnProperty;var kt=(t,a,c)=>{c=t!=null?ft(ht(t)):{};let s=a||!t||!t.__esModule?L(c,"default",{value:t,enumerable:!0}):c;for(let m of ut(t))if(!wt.call(s,m))L(s,m,{get:()=>t[m],enumerable:!0});return s};var xt=((t)=>typeof require!=="undefined"?require:typeof Proxy!=="undefined"?new Proxy(t,{get:(a,c)=>(typeof require!=="undefined"?require:a)[c]}):t)(function(t){if(typeof require!=="undefined")return require.apply(this,arguments);throw Error('Dynamic require of "'+t+'" is not supported')});class A{providers=new Map;register(t){this.providers.set(t.id,t)}get(t){return this.providers.get(t)}has(t){return this.providers.has(t)}}import{object as p,string as $,number as W,boolean as I,array as N,optional as R,record as lt,union as K}from"dhi";var yt=p({id:$(),type:$(),function:p({name:$(),arguments:$()})}),Ct=p({type:$(),text:$()}),gt=p({type:$(),image_url:p({url:$()})}),$t=K([$(),N(K([Ct,gt]))]),Rt=p({role:$(),content:$t,name:R($()),tool_call_id:R($()),tool_calls:R(N(yt))}),pt=p({provider:$(),model:$(),messages:N(Rt),temperature:R(W()),max_tokens:R(W()),top_p:R(W()),stream:R(I()),json:R(I()),extraHeaders:R(lt($()))}),Gt=new Set(["openai","anthropic","groq","gemini","openrouter","sambanova","cerebras","v1"]);function At(t){if(!Gt.has(t))throw new Error(`Unknown provider: ${t}`)}function M(t){let a=pt.safeParse(t);if(!a.success){let n=a.error?.toString?.()??"Invalid request";throw new Error(n)}At(a.data.provider);let c=t?.signal,{tools:s,tool_choice:m}=t||{};return{...a.data,tools:s,tool_choice:m,signal:c}}var Mt={openai:"openai","open-ai":"openai",oai:"openai",anthropic:"anthropic",claude:"anthropic",groq:"groq",gemini:"gemini",google:"gemini","google-ai":"gemini",openrouter:"openrouter","open-router":"openrouter",sambanova:"sambanova",samba:"sambanova",cerebras:"cerebras","cerebras-ai":"cerebras",cs:"cerebras",v1:"v1","openai-compatible":"v1","oai-compat":"v1"},Jt=[{test:(t)=>/^(gpt-|o[34](?:\b|-|_)).*/i.test(t),provider:"openai"},{test:(t)=>/^(claude-)/i.test(t),provider:"anthropic"},{test:(t)=>/^(gemini-)/i.test(t),provider:"gemini"},{test:(t)=>/^(llama|llama-?|meta-llama|mixtral|mistral)/i.test(t),provider:"groq"}];function U(t){if(!t)return;let a=t.trim().toLowerCase();return Mt[a]}function b(t){if(!t)return;let a=t.trim();for(let{test:c,provider:s}of Jt)if(c(a))return s;return}function J(t){let a=t.trim(),c=a.split(/[\/:\s]+/).filter(Boolean);if(c.length===0)return{};let s=U(c[0]);if(s){let o=c.slice(1).join("/");return{provider:s,model:o||void 0}}let m=a;return{provider:b(m),model:m}}function X(t){let a,c;if(typeof t==="string"){let s=J(t);a=s.provider,c=s.model}else if("target"in t&&typeof t.target==="string"){let s=J(t.target);a=s.provider,c=s.model}else{if(a=U(t?.provider),c=t?.model,(!c||!a)&&typeof t?.provider==="string"&&t.provider.includes("/")){let s=J(t.provider);a=a??s.provider,c=c??s.model}if(typeof c==="string"&&c.includes("/")){let s=J(c);if(a=a??s.provider,s.model)c=s.model}if(!a&&typeof c==="string")a=b(c)}if(!a||!c)throw new Error("Could not resolve provider/model from input. Accepts 'provider/model' (e.g. 'openai/gpt-4o-mini') or separate { provider, model }.");return{provider:a,model:c}}var P;function Pt(){try{let t=typeof process!=="undefined"?process:void 0;return!!t?.versions?.node&&!t?.versions?.bun}catch{return!1}}function St(t){try{let a=new URL(t);return`${a.protocol}//${a.host}`}catch{return}}async function j(t){if(!Pt())return;try{if((typeof process!=="undefined"&&process.env?.HRI_USE_UNDICI)==="0")return}catch{}let a=St(t);if(!a)return;try{let c=await import("undici"),{Pool:s}=c;if(!P)P=new Map;let m=P.get(a);if(!m)m=new s(a,{connections:8,pipelining:1,keepAliveTimeout:1e4,keepAliveMaxTimeout:60000}),P.set(a,m);return m}catch{return}}function k(t,a){if(a.startsWith("http"))return a;return`${t.replace(/\/$/,"")}/${a.replace(/^\//,"")}`}async function x(t,a={}){let{method:c="POST",headers:s={},body:m,signal:n}=a,o=!1;try{let h=typeof process!=="undefined"?process:void 0;o=!!h?.versions?.node&&!h?.versions?.bun}catch{o=!1}let _={method:c,headers:s,body:typeof m==="string"||m instanceof Uint8Array?m:m?JSON.stringify(m):void 0,signal:n,...o?{keepalive:!0}:{}},i=await j(t);if(i)_.dispatcher=i;return fetch(t,_)}async function*zt(t){let a=t.getReader(),c=new TextDecoder,s="";try{while(!0){let{done:m,value:n}=await a.read();if(m)break;s+=c.decode(n,{stream:!0});let o;while((o=s.indexOf(`
`))!==-1){let _=s.slice(0,o);s=s.slice(o+1),yield _.replace(/\r$/,"")}}if(s.length>0)yield s}finally{a.releaseLock()}}async function*g(t){let a=[],c;for await(let s of zt(t)){if(s===""){let _=a.length?a.join(`
`):void 0;yield _||c?{event:c,data:_}:null,a=[],c=void 0;continue}if(s.startsWith(":"))continue;let m=s.indexOf(":"),n=m===-1?s:s.slice(0,m),o=m===-1?"":s.slice(m+1).replace(/^\s*/,"");if(n==="event")c=o;else if(n==="data")a.push(o)}}var D="https://api.openai.com/v1";function Bt(t,a){let c=(t.choices??[]).map((s,m)=>({index:s.index??m,message:s.message??{role:"assistant",content:""},finish_reason:s.finish_reason??null}));return{id:t.id??"unknown",created:t.created??Math.floor(Date.now()/1000),model:t.model??"unknown",choices:c,usage:t.usage,provider:a,raw:t}}function d(t,a){return{...t||{},...a||{}}}class S{id="openai";name="OpenAI";isGpt5(t){try{return/(^|\/)gpt-5/i.test(t)}catch{return!1}}async chat(t,a,c){let s=k(c||D,"/chat/completions"),m=d({Authorization:`Bearer ${a||""}`,"Content-Type":"application/json",Accept:"application/json"},t.extraHeaders),n={model:t.model,messages:t.messages,temperature:t.temperature,top_p:t.top_p,stream:!1};if(t.max_tokens!=null)if(this.isGpt5(t.model))n.max_completion_tokens=t.max_tokens;else n.max_tokens=t.max_tokens;if(t.tools)n.tools=t.tools;if(t.tool_choice)n.tool_choice=t.tool_choice;if(t.json)n.response_format={type:"json_object"};let o=await x(s,{method:"POST",headers:m,body:n,signal:t.signal});if(!o.ok){let i=await o.text();throw new Error(`OpenAI error ${o.status}: ${i}`)}let _=await o.json();return Bt(_,this.id)}async*streamChat(t,a,c){let s=k(c||D,"/chat/completions"),m=d({Authorization:`Bearer ${a||""}`,"Content-Type":"application/json",Accept:"text/event-stream"},t.extraHeaders),n={model:t.model,messages:t.messages,temperature:t.temperature,top_p:t.top_p,stream:!0};if(t.max_tokens!=null)if(this.isGpt5(t.model))n.max_completion_tokens=t.max_tokens;else n.max_tokens=t.max_tokens;if(t.tools)n.tools=t.tools;if(t.tool_choice)n.tool_choice=t.tool_choice;if(t.json)n.response_format={type:"json_object"};let o=await x(s,{method:"POST",headers:m,body:n,signal:t.signal});if(!o.ok||!o.body){let _=await o.text();throw new Error(`OpenAI stream error ${o.status}: ${_}`)}for await(let _ of g(o.body)){if(!_||!_.data)continue;if(_.data==="[DONE]")return;try{let i=JSON.parse(_.data),h=i.choices?.[0],f=h?.delta||{};yield{id:i.id,created:i.created,model:i.model,delta:{role:f.role,content:f.content,tool_calls:Array.isArray(f.tool_calls)?f.tool_calls.map((u)=>({id:u.id??String(u.index??0),type:"function",function:{name:u.function?.name,arguments:u.function?.arguments??""}})):void 0},finish_reason:h?.finish_reason??null,raw:i}}catch(i){}}}async listModels(t,a){let c=k(a||D,"/models"),s={Authorization:`Bearer ${t||""}`,Accept:"application/json"},m=await x(c,{method:"GET",headers:s});if(!m.ok){let o=await m.text();throw new Error(`OpenAI models error ${m.status}: ${o}`)}let n=await m.json().catch(()=>({}));if(Array.isArray(n?.data))return n.data.map((o)=>o?.id).filter(Boolean);if(Array.isArray(n))return n.filter((o)=>typeof o==="string");return[]}}var e="https://api.anthropic.com",v="2023-06-01";function r(t){let a=[],c=[],s=(n)=>{if(typeof n==="string")return n;return(n||[]).map((o)=>o?.type==="text"?String(o.text??""):"").join("").trim()};for(let n of t.messages)if(n.role==="system")a.push(s(n.content));else if(n.role==="user"||n.role==="assistant")c.push({role:n.role,content:s(n.content)});return{system:a.length?a.join(`
`):void 0,messages:c}}function Ot(t,a,c){let m={role:"assistant",content:Array.isArray(t.content)?t.content.map((n)=>n.text||"").join(""):t.content?.[0]?.text||""};return{id:t.id??"unknown",created:Math.floor(Date.now()/1000),model:c,choices:[{index:0,message:m,finish_reason:t.stop_reason??null}],provider:a,raw:t}}class z{id="anthropic";name="Anthropic";async chat(t,a,c){let m=k(c||e,"/v1/messages"),{system:n,messages:o}=r(t),_={"x-api-key":a||"","content-type":"application/json","anthropic-version":v,...t.extraHeaders||{}},i={model:t.model,max_tokens:t.max_tokens??1024,temperature:t.temperature,system:n,messages:o},h=await x(m,{method:"POST",headers:_,body:i,signal:t.signal});if(!h.ok){let w=await h.text();throw new Error(`Anthropic error ${h.status}: ${w}`)}let f=await h.json();return Ot(f,this.id,t.model)}async*streamChat(t,a,c){let m=k(c||e,"/v1/messages"),{system:n,messages:o}=r(t),_={"x-api-key":a||"","content-type":"application/json",accept:"text/event-stream","anthropic-version":v,...t.extraHeaders||{}},i={model:t.model,max_tokens:t.max_tokens??1024,temperature:t.temperature,system:n,messages:o,stream:!0},h=await x(m,{method:"POST",headers:_,body:i,signal:t.signal});if(!h.ok||!h.body){let f=await h.text();throw new Error(`Anthropic stream error ${h.status}: ${f}`)}for await(let f of g(h.body)){if(!f||!f.data)continue;try{let w=JSON.parse(f.data),u=w.type;if(u==="content_block_delta"&&w.delta?.type==="text_delta")yield{delta:{role:"assistant",content:w.delta.text||""},raw:w};else if(u==="message_stop")return}catch{}}}}var E="https://api.groq.com/openai/v1";function Ht(t,a){let c=(t.choices??[]).map((s,m)=>({index:s.index??m,message:s.message??{role:"assistant",content:""},finish_reason:s.finish_reason??null}));return{id:t.id??"unknown",created:t.created??Math.floor(Date.now()/1000),model:t.model??"unknown",choices:c,usage:t.usage,provider:a,raw:t}}function q(t,a){return{...t||{},...a||{}}}class B{id="groq";name="Groq (OpenAI-compatible)";isGpt5(t){try{return/(^|\/)gpt-5/i.test(t)}catch{return!1}}async chat(t,a,c){let s=k(c||E,"/chat/completions"),m=q({Authorization:`Bearer ${a||""}`,"Content-Type":"application/json",Accept:"application/json"},t.extraHeaders),n={model:t.model,messages:t.messages,temperature:t.temperature,top_p:t.top_p,stream:!1};if(t.max_tokens!=null)if(this.isGpt5(t.model))n.max_completion_tokens=t.max_tokens;else n.max_tokens=t.max_tokens;if(t.tools)n.tools=t.tools;if(t.tool_choice)n.tool_choice=t.tool_choice;if(t.json)n.response_format={type:"json_object"};let o=await x(s,{method:"POST",headers:m,body:n,signal:t.signal});if(!o.ok){let i=await o.text();throw new Error(`Groq error ${o.status}: ${i}`)}let _=await o.json();return Ht(_,this.id)}async*streamChat(t,a,c){let s=k(c||E,"/chat/completions"),m=q({Authorization:`Bearer ${a||""}`,"Content-Type":"application/json",Accept:"text/event-stream"},t.extraHeaders),n={model:t.model,messages:t.messages,temperature:t.temperature,top_p:t.top_p,stream:!0};if(t.max_tokens!=null)if(this.isGpt5(t.model))n.max_completion_tokens=t.max_tokens;else n.max_tokens=t.max_tokens;if(t.tools)n.tools=t.tools;if(t.tool_choice)n.tool_choice=t.tool_choice;if(t.json)n.response_format={type:"json_object"};let o=await x(s,{method:"POST",headers:m,body:n,signal:t.signal});if(!o.ok||!o.body){let _=await o.text();throw new Error(`Groq stream error ${o.status}: ${_}`)}for await(let _ of g(o.body)){if(!_||!_.data)continue;if(_.data==="[DONE]")return;try{let i=JSON.parse(_.data),h=i.choices?.[0],f=h?.delta||{};yield{id:i.id,created:i.created,model:i.model,delta:{role:f.role,content:f.content,tool_calls:Array.isArray(f.tool_calls)?f.tool_calls.map((u)=>({id:u.id??String(u.index??0),type:"function",function:{name:u.function?.name,arguments:u.function?.arguments??""}})):void 0},finish_reason:h?.finish_reason??null,raw:i}}catch{}}}async listModels(t,a){let c=k(a||E,"/models"),s={Authorization:`Bearer ${t||""}`,Accept:"application/json"},m=await x(c,{method:"GET",headers:s});if(!m.ok){let o=await m.text();throw new Error(`Groq models error ${m.status}: ${o}`)}let n=await m.json().catch(()=>({}));if(Array.isArray(n?.data))return n.data.map((o)=>o?.id).filter(Boolean);if(Array.isArray(n))return n.filter((o)=>typeof o==="string");return[]}}var tt="https://openrouter.ai/api/v1";function Qt(t,a){let c=(t.choices??[]).map((s,m)=>({index:s.index??m,message:s.message??{role:"assistant",content:""},finish_reason:s.finish_reason??null}));return{id:t.id??"unknown",created:t.created??Math.floor(Date.now()/1000),model:t.model??"unknown",choices:c,usage:t.usage,provider:a,raw:t}}function nt(t,a){return{...t||{},...a||{}}}class O{id="openrouter";name="OpenRouter (OpenAI-compatible)";isGpt5(t){try{return/(^|\/)gpt-5/i.test(t)}catch{return!1}}async chat(t,a,c){let s=k(c||tt,"/chat/completions"),m=nt({Authorization:`Bearer ${a||""}`,"Content-Type":"application/json",Accept:"application/json"},t.extraHeaders),n={model:t.model,messages:t.messages,temperature:t.temperature,top_p:t.top_p,stream:!1};if(t.max_tokens!=null)if(this.isGpt5(t.model))n.max_completion_tokens=t.max_tokens;else n.max_tokens=t.max_tokens;if(t.tools)n.tools=t.tools;if(t.tool_choice)n.tool_choice=t.tool_choice;if(t.json)n.response_format={type:"json_object"};let o=await x(s,{method:"POST",headers:m,body:n,signal:t.signal});if(!o.ok){let i=await o.text();throw new Error(`OpenRouter error ${o.status}: ${i}`)}let _=await o.json();return Qt(_,this.id)}async*streamChat(t,a,c){let s=k(c||tt,"/chat/completions"),m=nt({Authorization:`Bearer ${a||""}`,"Content-Type":"application/json",Accept:"text/event-stream"},t.extraHeaders),n={model:t.model,messages:t.messages,temperature:t.temperature,top_p:t.top_p,stream:!0};if(t.max_tokens!=null)if(this.isGpt5(t.model))n.max_completion_tokens=t.max_tokens;else n.max_tokens=t.max_tokens;if(t.tools)n.tools=t.tools;if(t.tool_choice)n.tool_choice=t.tool_choice;if(t.json)n.response_format={type:"json_object"};let o=await x(s,{method:"POST",headers:m,body:n,signal:t.signal});if(!o.ok||!o.body){let _=await o.text();throw new Error(`OpenRouter stream error ${o.status}: ${_}`)}for await(let _ of g(o.body)){if(!_||!_.data)continue;if(_.data==="[DONE]")return;try{let i=JSON.parse(_.data),h=i.choices?.[0],f=h?.delta||{};yield{id:i.id,created:i.created,model:i.model,delta:{role:f.role,content:f.content,tool_calls:Array.isArray(f.tool_calls)?f.tool_calls.map((u)=>({id:u.id??String(u.index??0),type:"function",function:{name:u.function?.name,arguments:u.function?.arguments??""}})):void 0},finish_reason:h?.finish_reason??null,raw:i}}catch{}}}}var at="https://api.sambanova.ai/v1";function Yt(t,a){let c=(t.choices??[]).map((s,m)=>({index:s.index??m,message:s.message??{role:"assistant",content:""},finish_reason:s.finish_reason??null}));return{id:t.id??"unknown",created:t.created??Math.floor(Date.now()/1000),model:t.model??"unknown",choices:c,usage:t.usage,provider:a,raw:t}}function st(t,a){return{...t||{},...a||{}}}class H{id="sambanova";name="SambaNova (OpenAI-compatible)";isGpt5(t){try{return/(^|\/)gpt-5/i.test(t)}catch{return!1}}async chat(t,a,c){let s=k(c||at,"/chat/completions"),m=st({Authorization:`Bearer ${a||""}`,"Content-Type":"application/json",Accept:"application/json"},t.extraHeaders),n={model:t.model,messages:t.messages,temperature:t.temperature,top_p:t.top_p,stream:!1};if(t.max_tokens!=null)if(this.isGpt5(t.model))n.max_completion_tokens=t.max_tokens;else n.max_tokens=t.max_tokens;if(t.tools)n.tools=t.tools;if(t.tool_choice)n.tool_choice=t.tool_choice;if(t.json)n.response_format={type:"json_object"};let o=await x(s,{method:"POST",headers:m,body:n,signal:t.signal});if(!o.ok){let i=await o.text();throw new Error(`SambaNova error ${o.status}: ${i}`)}let _=await o.json();return Yt(_,this.id)}async*streamChat(t,a,c){let s=k(c||at,"/chat/completions"),m=st({Authorization:`Bearer ${a||""}`,"Content-Type":"application/json",Accept:"text/event-stream"},t.extraHeaders),n={model:t.model,messages:t.messages,temperature:t.temperature,top_p:t.top_p,stream:!0};if(t.max_tokens!=null)if(this.isGpt5(t.model))n.max_completion_tokens=t.max_tokens;else n.max_tokens=t.max_tokens;if(t.tools)n.tools=t.tools;if(t.tool_choice)n.tool_choice=t.tool_choice;if(t.json)n.response_format={type:"json_object"};let o=await x(s,{method:"POST",headers:m,body:n,signal:t.signal});if(!o.ok||!o.body){let _=await o.text();throw new Error(`SambaNova stream error ${o.status}: ${_}`)}for await(let _ of g(o.body)){if(!_||!_.data)continue;if(_.data==="[DONE]")return;try{let i=JSON.parse(_.data),h=i.choices?.[0],f=h?.delta||{};yield{id:i.id,created:i.created,model:i.model,delta:{role:f.role,content:f.content,tool_calls:Array.isArray(f.tool_calls)?f.tool_calls.map((u)=>({id:u.id??String(u.index??0),type:"function",function:{name:u.function?.name,arguments:u.function?.arguments??""}})):void 0},finish_reason:h?.finish_reason??null,raw:i}}catch{}}}}var ot="https://generativelanguage.googleapis.com/v1beta/openai";function Zt(t,a){let c=(t.choices??[]).map((s,m)=>({index:s.index??m,message:s.message??{role:"assistant",content:""},finish_reason:s.finish_reason??null}));return{id:t.id??"unknown",created:t.created??Math.floor(Date.now()/1000),model:t.model??"unknown",choices:c,usage:t.usage,provider:a,raw:t}}function ct(t,a){return{...t||{},...a||{}}}class Q{id="gemini";name="Gemini (OpenAI-compatible)";isGpt5(t){try{return/(^|\/)gpt-5/i.test(t)}catch{return!1}}async chat(t,a,c){let s=k(c||ot,"/chat/completions"),m=ct({Authorization:`Bearer ${a||""}`,"Content-Type":"application/json",Accept:"application/json"},t.extraHeaders),n={model:t.model,messages:t.messages,temperature:t.temperature,top_p:t.top_p,stream:!1};if(t.max_tokens!=null)if(this.isGpt5(t.model))n.max_completion_tokens=t.max_tokens;else n.max_tokens=t.max_tokens;if(t.tools)n.tools=t.tools;if(t.tool_choice)n.tool_choice=t.tool_choice;if(t.json)n.response_format={type:"json_object"};let o=await x(s,{method:"POST",headers:m,body:n,signal:t.signal});if(!o.ok){let i=await o.text();throw new Error(`Gemini error ${o.status}: ${i}`)}let _=await o.json();return Zt(_,this.id)}async*streamChat(t,a,c){let s=k(c||ot,"/chat/completions"),m=ct({Authorization:`Bearer ${a||""}`,"Content-Type":"application/json",Accept:"text/event-stream"},t.extraHeaders),n={model:t.model,messages:t.messages,temperature:t.temperature,top_p:t.top_p,stream:!0};if(t.max_tokens!=null)if(this.isGpt5(t.model))n.max_completion_tokens=t.max_tokens;else n.max_tokens=t.max_tokens;if(t.tools)n.tools=t.tools;if(t.tool_choice)n.tool_choice=t.tool_choice;if(t.json)n.response_format={type:"json_object"};let o=await x(s,{method:"POST",headers:m,body:n,signal:t.signal});if(!o.ok||!o.body){let _=await o.text();throw new Error(`Gemini stream error ${o.status}: ${_}`)}for await(let _ of g(o.body)){if(!_||!_.data)continue;if(_.data==="[DONE]")return;try{let i=JSON.parse(_.data),h=i.choices?.[0],f=h?.delta||{};yield{id:i.id,created:i.created,model:i.model,delta:{role:f.role,content:f.content,tool_calls:Array.isArray(f.tool_calls)?f.tool_calls.map((u)=>({id:u.id??String(u.index??0),type:"function",function:{name:u.function?.name,arguments:u.function?.arguments??""}})):void 0},finish_reason:h?.finish_reason??null,raw:i}}catch{}}}}var V="https://api.cerebras.ai/v1";function Wt(t,a){let c=(t.choices??[]).map((s,m)=>({index:s.index??m,message:s.message??{role:"assistant",content:""},finish_reason:s.finish_reason??null}));return{id:t.id??"unknown",created:t.created??Math.floor(Date.now()/1000),model:t.model??"unknown",choices:c,usage:t.usage,provider:a,raw:t}}function mt(t,a){return{...t||{},...a||{}}}class Y{id="cerebras";name="Cerebras (OpenAI-compatible)";isGpt5(t){try{return/(^|\/)gpt-5/i.test(t)}catch{return!1}}async chat(t,a,c){let s=k(c||V,"/chat/completions"),m=mt({Authorization:`Bearer ${a||""}`,"Content-Type":"application/json",Accept:"application/json"},t.extraHeaders),n={model:t.model,messages:t.messages,temperature:t.temperature,top_p:t.top_p,stream:!1};if(t.max_tokens!=null)if(this.isGpt5(t.model))n.max_completion_tokens=t.max_tokens;else n.max_tokens=t.max_tokens;if(t.tools)n.tools=t.tools;if(t.tool_choice)n.tool_choice=t.tool_choice;if(t.json)n.response_format={type:"json_object"};let o=await x(s,{method:"POST",headers:m,body:n,signal:t.signal});if(!o.ok){let i=await o.text();throw new Error(`Cerebras error ${o.status}: ${i}`)}let _=await o.json();return Wt(_,this.id)}async*streamChat(t,a,c){let s=k(c||V,"/chat/completions"),m=mt({Authorization:`Bearer ${a||""}`,"Content-Type":"application/json",Accept:"text/event-stream"},t.extraHeaders),n={model:t.model,messages:t.messages,temperature:t.temperature,top_p:t.top_p,stream:!0};if(t.max_tokens!=null)if(this.isGpt5(t.model))n.max_completion_tokens=t.max_tokens;else n.max_tokens=t.max_tokens;if(t.tools)n.tools=t.tools;if(t.tool_choice)n.tool_choice=t.tool_choice;if(t.json)n.response_format={type:"json_object"};let o=await x(s,{method:"POST",headers:m,body:n,signal:t.signal});if(!o.ok||!o.body){let _=await o.text();throw new Error(`Cerebras stream error ${o.status}: ${_}`)}for await(let _ of g(o.body)){if(!_||!_.data)continue;if(_.data==="[DONE]")return;try{let i=JSON.parse(_.data),h=i.choices?.[0],f=h?.delta||{};yield{id:i.id,created:i.created,model:i.model,delta:{role:f.role,content:f.content,tool_calls:Array.isArray(f.tool_calls)?f.tool_calls.map((u)=>({id:u.id??String(u.index??0),type:"function",function:{name:u.function?.name,arguments:u.function?.arguments??""}})):void 0},finish_reason:h?.finish_reason??null,raw:i}}catch{}}}async listModels(t,a){let c=k(a||V,"/models"),s={Authorization:`Bearer ${t||""}`,Accept:"application/json"},m=await x(c,{method:"GET",headers:s});if(!m.ok){let o=await m.text();throw new Error(`Cerebras models error ${m.status}: ${o}`)}let n=await m.json().catch(()=>({}));if(Array.isArray(n?.data))return n.data.map((o)=>o?.id).filter(Boolean);if(Array.isArray(n))return n.filter((o)=>typeof o==="string");return[]}}var T=void 0;function Nt(t,a){let c=(t.choices??[]).map((s,m)=>({index:s.index??m,message:s.message??{role:"assistant",content:""},finish_reason:s.finish_reason??null}));return{id:t.id??"unknown",created:t.created??Math.floor(Date.now()/1000),model:t.model??"unknown",choices:c,usage:t.usage,provider:a,raw:t}}function _t(t,a){return{...t||{},...a||{}}}class Z{id="v1";name="Generic V1 (OpenAI-compatible)";isGpt5(t){try{return/(^|\/)gpt-5/i.test(t)}catch{return!1}}async chat(t,a,c){let s=k(c||T,"/chat/completions"),m=_t({Authorization:`Bearer ${a||""}`,"Content-Type":"application/json",Accept:"application/json"},t.extraHeaders),n={model:t.model,messages:t.messages,temperature:t.temperature,top_p:t.top_p,stream:!1};if(t.max_tokens!=null)if(this.isGpt5(t.model))n.max_completion_tokens=t.max_tokens;else n.max_tokens=t.max_tokens;if(t.tools)n.tools=t.tools;if(t.tool_choice)n.tool_choice=t.tool_choice;if(t.json)n.response_format={type:"json_object"};let o=await x(s,{method:"POST",headers:m,body:n,signal:t.signal});if(!o.ok){let i=await o.text();throw new Error(`V1 error ${o.status}: ${i}`)}let _=await o.json();return Nt(_,this.id)}async*streamChat(t,a,c){let s=k(c||T,"/chat/completions"),m=_t({Authorization:`Bearer ${a||""}`,"Content-Type":"application/json",Accept:"text/event-stream"},t.extraHeaders),n={model:t.model,messages:t.messages,temperature:t.temperature,top_p:t.top_p,stream:!0};if(t.max_tokens!=null)if(this.isGpt5(t.model))n.max_completion_tokens=t.max_tokens;else n.max_tokens=t.max_tokens;if(t.tools)n.tools=t.tools;if(t.tool_choice)n.tool_choice=t.tool_choice;if(t.json)n.response_format={type:"json_object"};let o=await x(s,{method:"POST",headers:m,body:n,signal:t.signal});if(!o.ok||!o.body){let _=await o.text();throw new Error(`V1 stream error ${o.status}: ${_}`)}for await(let _ of g(o.body)){if(!_||!_.data)continue;if(_.data==="[DONE]")return;try{let i=JSON.parse(_.data),h=i.choices?.[0],f=h?.delta||{};yield{id:i.id,created:i.created,model:i.model,delta:{role:f.role,content:f.content,tool_calls:Array.isArray(f.tool_calls)?f.tool_calls.map((u)=>({id:u.id??String(u.index??0),type:"function",function:{name:u.function?.name,arguments:u.function?.arguments??""}})):void 0},finish_reason:h?.finish_reason??null,raw:i}}catch{}}}async listModels(t,a){let c=k(a||T,"/models"),s={Authorization:`Bearer ${t||""}`,Accept:"application/json"},m=await x(c,{method:"GET",headers:s});if(!m.ok){let o=await m.text();throw new Error(`V1 models error ${m.status}: ${o}`)}let n=await m.json().catch(()=>({}));if(Array.isArray(n?.data))return n.data.map((o)=>o?.id).filter(Boolean);if(Array.isArray(n))return n.filter((o)=>typeof o==="string");return[]}}function Xt(t){try{return typeof process!=="undefined"&&process?.env?.[t]||void 0}catch{return}}function Dt(t){return Xt({openai:"OPENAI_API_KEY",anthropic:"ANTHROPIC_API_KEY",groq:"GROQ_API_KEY",gemini:"GEMINI_API_KEY",openrouter:"OPENROUTER_API_KEY",sambanova:"SAMBANOVA_API_KEY",cerebras:"CEREBRAS_API_KEY",v1:"V1_API_KEY"}[t])}function Et(t){switch(t){case"openai":return"https://api.openai.com/v1";case"anthropic":return"https://api.anthropic.com";default:return}}class it{registry;config;constructor(t={},a){this.config=t,this.registry=a??new A}static createDefault(t={}){let a=new it(t);return a.use(new S),a.use(new z),a.use(new B),a.use(new O),a.use(new H),a.use(new Q),a.use(new Y),a.use(new Z),a}use(t){return this.registry.register(t),this}apiKeyFor(t){return this.config.apiKeys?.[t]??Dt(t)}baseUrlFor(t){if(this.config.baseUrls?.[t])return this.config.baseUrls[t];if(this.config.proxy)switch(t){case"openai":return`${this.config.proxy.replace(/\/$/,"")}/openai/v1`;case"anthropic":return`${this.config.proxy.replace(/\/$/,"")}/anthropic`;case"v1":return`${this.config.proxy.replace(/\/$/,"")}/v1`;default:return this.config.proxy}return Et(t)}async chat(t,a){let c=this.normalizeInput(t,a),s=M(c),m=this.registry.get(s.provider);if(!m)throw new Error(`Provider not registered: ${s.provider}`);let n=this.apiKeyFor(m.id),o=this.baseUrlFor(m.id),_=await m.chat({...s,stream:!1},n,o);try{this.config.onUsage?.(_.usage,{provider:m.id,model:s.model})}catch{}return _}streamChat(t,a){let c=this.normalizeInput(t,{...a,stream:!0}),s=M({...c,stream:!0}),m=this.registry.get(s.provider);if(!m||!m.streamChat)throw new Error(`Provider does not support streaming: ${s.provider}`);let n=this.apiKeyFor(m.id),o=this.baseUrlFor(m.id);return m.streamChat(s,n,o)}async streamToText(t,a){let c=this.normalizeInput(t,{...a,stream:!0}),s="";for await(let m of this.streamChat({...c,stream:!0})){let n=m.delta?.content;if(typeof n==="string")s+=n}return s}async chatWithTools(t,a,c={}){let s=c.maxCalls??10,m=[...t.messages],n=0,o=t.tool_choice;while(n<=s){let _=await this.chat({...t,messages:m,stream:!1,tool_choice:o}),h=_.choices?.[0]?.message,f=h?.tool_calls||[];if(!f.length)return _;m.push({role:"assistant",content:h?.content||"",tool_calls:f});for(let w of f){if(w.type!=="function")continue;let u=w.function?.name,l=a[u],y={};try{y=w.function?.arguments?JSON.parse(w.function.arguments):{}}catch{y={}}let C;try{if(!l)throw new Error(`No handler for tool: ${u}`);C=await l(y)}catch(F){C={error:String(F?.message||F)}}let G=typeof C==="string"?C:JSON.stringify(C);m.push({role:"tool",content:G,tool_call_id:w.id})}if(n+=1,o==="required"||o&&typeof o==="object")o="none";else o="auto"}throw new Error(`Exceeded max tool calls (${s}) during chatWithTools()`)}async*streamWithTools(t,a,c={}){let s=c.maxCalls??10,m={...t,stream:!0},n=[...t.messages],o=0,_=t.tool_choice;while(o<=s){let i=this.streamChat({...m,messages:n,tool_choice:_}),h=new Map;for await(let w of i){let u=w.delta?.tool_calls||[];for(let l of u){if(!l)continue;let y=l.id||"0",C=h.get(y)??{name:l.function?.name,args:""};if(l.function?.name)C.name=l.function.name;if(l.function?.arguments)C.args+=l.function.arguments;h.set(y,C)}yield w}if(h.size===0)return;let f=Array.from(h.entries()).filter(([,w])=>w.name&&w.name.length>0).map(([w,u])=>({id:w,type:"function",function:{name:u.name,arguments:u.args||"{}"}}));if(f.length===0)return;n.push({role:"assistant",content:"",tool_calls:f});for(let w of f){let u=a[w.function.name],l={};try{l=w.function.arguments?JSON.parse(w.function.arguments):{}}catch{l={}}let y;try{if(!u)throw new Error(`No handler for tool: ${w.function.name}`);y=await u(l)}catch(G){y={error:String(G?.message||G)}}let C=typeof y==="string"?y:JSON.stringify(y);n.push({role:"tool",content:C,tool_call_id:w.id})}if(o+=1,_==="required"||_&&typeof _==="object")_="none";else _="auto"}throw new Error(`Exceeded max tool calls (${s}) during streamWithTools()`)}async verifyModel(t){let a=this.normalizeInput(t),{provider:c,model:s}=a,m=this.registry.get(c);if(!m)throw new Error(`Provider not registered: ${c}`);let n=this.apiKeyFor(c),o=this.baseUrlFor(c);try{if(m.listModels){let _=await m.listModels(n,o);return{exists:!!_?.includes(s),provider:c,model:s,models:_}}}catch(_){return{exists:!1,provider:c,model:s,error:String(_?.message||_)}}if(!o)return{exists:!1,provider:c,model:s,error:"Base URL is not configured for provider; cannot query /models."};try{let _=k(o,"/models"),i={Authorization:`Bearer ${n||""}`,Accept:"application/json"},h=await x(_,{method:"GET",headers:i});if(!h.ok){let l=await h.text(),y=h.status,C="Unknown error querying /models.";if(y===401)C="Unauthorized: API key missing or invalid.";else if(y===403)C="Forbidden: key lacks permission for /models.";else if(y===404)C="Not found: base URL may be wrong (no /models).";else if(y>=500)C="Provider server error (5xx).";return{exists:!1,provider:c,model:s,status:y,error:`${C} ${l}`}}let f=await h.json().catch(()=>({})),w=Array.isArray(f?.data)?f.data.map((l)=>l?.id).filter(Boolean):Array.isArray(f)?f.filter((l)=>typeof l==="string"):[];return{exists:!!w?.includes(s),provider:c,model:s,models:w}}catch(_){let i=String(_?.message||_),h=i.includes("fetch failed")?"Network/CORS/proxy error while calling /models.":"";return{exists:!1,provider:c,model:s,error:[h,i].filter(Boolean).join(" ")}}}normalizeInput(t,a){if(typeof t==="string"){let{provider:_,model:i}=X(t),h={...a||{}},f=h.messages||[];return{...h,provider:_,model:i,messages:f}}let c={...t,...a||{}},{provider:s,model:m}=X(c),{target:n,...o}=c;return{...o,provider:s,model:m}}}export{M as validateChatRequest,Z as V1Provider,H as SambaNovaProvider,A as ProviderRegistry,O as OpenRouterProvider,S as OpenAIProvider,it as HRI,B as GroqProvider,Q as GeminiProvider,Y as CerebrasProvider,z as AnthropicProvider};

//# debugId=EA310D8E257254E964756E2164756E21
//# sourceMappingURL=index.js.map
