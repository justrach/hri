var v=Object.create;var{getPrototypeOf:q,defineProperty:z,getOwnPropertyNames:tt}=Object;var st=Object.prototype.hasOwnProperty;var nt=(t,s,c)=>{c=t!=null?v(q(t)):{};let a=s||!t||!t.__esModule?z(c,"default",{value:t,enumerable:!0}):c;for(let e of tt(t))if(!st.call(a,e))z(a,e,{get:()=>t[e],enumerable:!0});return a};var at=((t)=>typeof require!=="undefined"?require:typeof Proxy!=="undefined"?new Proxy(t,{get:(s,c)=>(typeof require!=="undefined"?require:s)[c]}):t)(function(t){if(typeof require!=="undefined")return require.apply(this,arguments);throw Error('Dynamic require of "'+t+'" is not supported')});class R{providers=new Map;register(t){this.providers.set(t.id,t)}get(t){return this.providers.get(t)}has(t){return this.providers.has(t)}}import{object as S,string as w,number as N,boolean as D,array as B,optional as d,record as ot}from"dhi";var et=S({id:w(),type:w(),function:S({name:w(),arguments:w()})}),ct=S({role:w(),content:w(),name:d(w()),tool_call_id:d(w()),tool_calls:d(B(et))}),it=S({provider:w(),model:w(),messages:B(ct),temperature:d(N()),max_tokens:d(N()),top_p:d(N()),stream:d(D()),json:d(D()),extraHeaders:d(ot(w()))});function mt(t){if(!["openai","anthropic","groq","gemini","openrouter","sambanova"].includes(t))throw new Error(`Unknown provider: ${t}`)}function P(t){let s=it.safeParse(t);if(!s.success){let n=s.error?.toString?.()??"Invalid request";throw new Error(n)}mt(s.data.provider);let c=t?.signal,{tools:a,tool_choice:e}=t||{};return{...s.data,tools:a,tool_choice:e,signal:c}}var A;function ht(){try{return typeof process!=="undefined"&&!!process.versions?.node}catch{return!1}}function pt(t){try{let s=new URL(t);return`${s.protocol}//${s.host}`}catch{return}}async function H(t){if(!ht())return;try{if((typeof process!=="undefined"&&process.env?.HRI_USE_UNDICI)!=="1")return}catch{return}let s=pt(t);if(!s)return;try{let c=await import("undici"),{Pool:a}=c;if(!A)A=new Map;let e=A.get(s);if(!e)e=new a(s,{connections:8,pipelining:1,keepAliveTimeout:1e4,keepAliveMaxTimeout:60000}),A.set(s,e);return e}catch{return}}function f(t,s){if(s.startsWith("http"))return s;return`${t.replace(/\/$/,"")}/${s.replace(/^\//,"")}`}async function l(t,s={}){let{method:c="POST",headers:a={},body:e,signal:n}=s,o={method:c,headers:a,body:typeof e==="string"||e instanceof Uint8Array?e:e?JSON.stringify(e):void 0,signal:n,keepalive:!0},i=await H(t);if(i)o.dispatcher=i;return fetch(t,o)}async function*_t(t){let s=t.getReader(),c=new TextDecoder,a="";try{while(!0){let{done:e,value:n}=await s.read();if(e)break;a+=c.decode(n,{stream:!0});let o;while((o=a.indexOf(`
`))!==-1){let i=a.slice(0,o);a=a.slice(o+1),yield i.replace(/\r$/,"")}}if(a.length>0)yield a}finally{s.releaseLock()}}async function*y(t){let s=[],c;for await(let a of _t(t)){if(a===""){let i=s.length?s.join(`
`):void 0;yield i||c?{event:c,data:i}:null,s=[],c=void 0;continue}if(a.startsWith(":"))continue;let e=a.indexOf(":"),n=e===-1?a:a.slice(0,e),o=e===-1?"":a.slice(e+1).replace(/^\s*/,"");if(n==="event")c=o;else if(n==="data")s.push(o)}}var J="https://api.openai.com/v1";function ut(t,s){let c=(t.choices??[]).map((a,e)=>({index:a.index??e,message:a.message??{role:"assistant",content:""},finish_reason:a.finish_reason??null}));return{id:t.id??"unknown",created:t.created??Math.floor(Date.now()/1000),model:t.model??"unknown",choices:c,usage:t.usage,provider:s,raw:t}}function V(t,s){return{...t||{},...s||{}}}class ${id="openai";name="OpenAI";isGpt5(t){try{return/(^|\/)gpt-5/i.test(t)}catch{return!1}}async chat(t,s,c){let a=f(c||J,"/chat/completions"),e=V({Authorization:`Bearer ${s||""}`,"Content-Type":"application/json",Accept:"application/json"},t.extraHeaders),n={model:t.model,messages:t.messages,temperature:t.temperature,top_p:t.top_p,stream:!1};if(t.max_tokens!=null)if(this.isGpt5(t.model))n.max_completion_tokens=t.max_tokens;else n.max_tokens=t.max_tokens;if(t.tools)n.tools=t.tools;if(t.tool_choice)n.tool_choice=t.tool_choice;if(t.json)n.response_format={type:"json_object"};let o=await l(a,{method:"POST",headers:e,body:n,signal:t.signal});if(!o.ok){let m=await o.text();throw new Error(`OpenAI error ${o.status}: ${m}`)}let i=await o.json();return ut(i,this.id)}async*streamChat(t,s,c){let a=f(c||J,"/chat/completions"),e=V({Authorization:`Bearer ${s||""}`,"Content-Type":"application/json",Accept:"text/event-stream"},t.extraHeaders),n={model:t.model,messages:t.messages,temperature:t.temperature,top_p:t.top_p,stream:!0};if(t.max_tokens!=null)if(this.isGpt5(t.model))n.max_completion_tokens=t.max_tokens;else n.max_tokens=t.max_tokens;if(t.tools)n.tools=t.tools;if(t.tool_choice)n.tool_choice=t.tool_choice;if(t.json)n.response_format={type:"json_object"};let o=await l(a,{method:"POST",headers:e,body:n,signal:t.signal});if(!o.ok||!o.body){let i=await o.text();throw new Error(`OpenAI stream error ${o.status}: ${i}`)}for await(let i of y(o.body)){if(!i||!i.data)continue;if(i.data==="[DONE]")return;try{let m=JSON.parse(i.data),_=m.choices?.[0],h=_?.delta||{};yield{id:m.id,created:m.created,model:m.model,delta:{role:h.role,content:h.content,tool_calls:Array.isArray(h.tool_calls)?h.tool_calls.map((p)=>({id:p.id??String(p.index??0),type:"function",function:{name:p.function?.name,arguments:p.function?.arguments??""}})):void 0},finish_reason:_?.finish_reason??null,raw:m}}catch(m){}}}}var I="https://api.anthropic.com",Q="2023-06-01";function W(t){let s=[],c=[];for(let e of t.messages)if(e.role==="system")s.push(e.content);else if(e.role==="user"||e.role==="assistant")c.push({role:e.role,content:e.content});return{system:s.length?s.join(`
`):void 0,messages:c}}function ft(t,s,c){let e={role:"assistant",content:Array.isArray(t.content)?t.content.map((n)=>n.text||"").join(""):t.content?.[0]?.text||""};return{id:t.id??"unknown",created:Math.floor(Date.now()/1000),model:c,choices:[{index:0,message:e,finish_reason:t.stop_reason??null}],provider:s,raw:t}}class O{id="anthropic";name="Anthropic";async chat(t,s,c){let e=f(c||I,"/v1/messages"),{system:n,messages:o}=W(t),i={"x-api-key":s||"","content-type":"application/json","anthropic-version":Q,...t.extraHeaders||{}},m={model:t.model,max_tokens:t.max_tokens??1024,temperature:t.temperature,system:n,messages:o},_=await l(e,{method:"POST",headers:i,body:m,signal:t.signal});if(!_.ok){let u=await _.text();throw new Error(`Anthropic error ${_.status}: ${u}`)}let h=await _.json();return ft(h,this.id,t.model)}async*streamChat(t,s,c){let e=f(c||I,"/v1/messages"),{system:n,messages:o}=W(t),i={"x-api-key":s||"","content-type":"application/json",accept:"text/event-stream","anthropic-version":Q,...t.extraHeaders||{}},m={model:t.model,max_tokens:t.max_tokens??1024,temperature:t.temperature,system:n,messages:o,stream:!0},_=await l(e,{method:"POST",headers:i,body:m,signal:t.signal});if(!_.ok||!_.body){let h=await _.text();throw new Error(`Anthropic stream error ${_.status}: ${h}`)}for await(let h of y(_.body)){if(!h||!h.data)continue;try{let u=JSON.parse(h.data),p=u.type;if(p==="content_block_delta"&&u.delta?.type==="text_delta")yield{delta:{role:"assistant",content:u.delta.text||""},raw:u};else if(p==="message_stop")return}catch{}}}}var X="https://api.groq.com/openai/v1";function lt(t,s){let c=(t.choices??[]).map((a,e)=>({index:a.index??e,message:a.message??{role:"assistant",content:""},finish_reason:a.finish_reason??null}));return{id:t.id??"unknown",created:t.created??Math.floor(Date.now()/1000),model:t.model??"unknown",choices:c,usage:t.usage,provider:s,raw:t}}function Y(t,s){return{...t||{},...s||{}}}class E{id="groq";name="Groq (OpenAI-compatible)";isGpt5(t){try{return/(^|\/)gpt-5/i.test(t)}catch{return!1}}async chat(t,s,c){let a=f(c||X,"/chat/completions"),e=Y({Authorization:`Bearer ${s||""}`,"Content-Type":"application/json",Accept:"application/json"},t.extraHeaders),n={model:t.model,messages:t.messages,temperature:t.temperature,top_p:t.top_p,stream:!1};if(t.max_tokens!=null)if(this.isGpt5(t.model))n.max_completion_tokens=t.max_tokens;else n.max_tokens=t.max_tokens;if(t.tools)n.tools=t.tools;if(t.tool_choice)n.tool_choice=t.tool_choice;if(t.json)n.response_format={type:"json_object"};let o=await l(a,{method:"POST",headers:e,body:n,signal:t.signal});if(!o.ok){let m=await o.text();throw new Error(`Groq error ${o.status}: ${m}`)}let i=await o.json();return lt(i,this.id)}async*streamChat(t,s,c){let a=f(c||X,"/chat/completions"),e=Y({Authorization:`Bearer ${s||""}`,"Content-Type":"application/json",Accept:"text/event-stream"},t.extraHeaders),n={model:t.model,messages:t.messages,temperature:t.temperature,top_p:t.top_p,stream:!0};if(t.max_tokens!=null)if(this.isGpt5(t.model))n.max_completion_tokens=t.max_tokens;else n.max_tokens=t.max_tokens;if(t.tools)n.tools=t.tools;if(t.tool_choice)n.tool_choice=t.tool_choice;if(t.json)n.response_format={type:"json_object"};let o=await l(a,{method:"POST",headers:e,body:n,signal:t.signal});if(!o.ok||!o.body){let i=await o.text();throw new Error(`Groq stream error ${o.status}: ${i}`)}for await(let i of y(o.body)){if(!i||!i.data)continue;if(i.data==="[DONE]")return;try{let m=JSON.parse(i.data),_=m.choices?.[0],h=_?.delta||{};yield{id:m.id,created:m.created,model:m.model,delta:{role:h.role,content:h.content,tool_calls:Array.isArray(h.tool_calls)?h.tool_calls.map((p)=>({id:p.id??String(p.index??0),type:"function",function:{name:p.function?.name,arguments:p.function?.arguments??""}})):void 0},finish_reason:_?.finish_reason??null,raw:m}}catch{}}}}var Z="https://openrouter.ai/api/v1";function xt(t,s){let c=(t.choices??[]).map((a,e)=>({index:a.index??e,message:a.message??{role:"assistant",content:""},finish_reason:a.finish_reason??null}));return{id:t.id??"unknown",created:t.created??Math.floor(Date.now()/1000),model:t.model??"unknown",choices:c,usage:t.usage,provider:s,raw:t}}function F(t,s){return{...t||{},...s||{}}}class M{id="openrouter";name="OpenRouter (OpenAI-compatible)";isGpt5(t){try{return/(^|\/)gpt-5/i.test(t)}catch{return!1}}async chat(t,s,c){let a=f(c||Z,"/chat/completions"),e=F({Authorization:`Bearer ${s||""}`,"Content-Type":"application/json",Accept:"application/json"},t.extraHeaders),n={model:t.model,messages:t.messages,temperature:t.temperature,top_p:t.top_p,stream:!1};if(t.max_tokens!=null)if(this.isGpt5(t.model))n.max_completion_tokens=t.max_tokens;else n.max_tokens=t.max_tokens;if(t.tools)n.tools=t.tools;if(t.tool_choice)n.tool_choice=t.tool_choice;if(t.json)n.response_format={type:"json_object"};let o=await l(a,{method:"POST",headers:e,body:n,signal:t.signal});if(!o.ok){let m=await o.text();throw new Error(`OpenRouter error ${o.status}: ${m}`)}let i=await o.json();return xt(i,this.id)}async*streamChat(t,s,c){let a=f(c||Z,"/chat/completions"),e=F({Authorization:`Bearer ${s||""}`,"Content-Type":"application/json",Accept:"text/event-stream"},t.extraHeaders),n={model:t.model,messages:t.messages,temperature:t.temperature,top_p:t.top_p,stream:!0};if(t.max_tokens!=null)if(this.isGpt5(t.model))n.max_completion_tokens=t.max_tokens;else n.max_tokens=t.max_tokens;if(t.tools)n.tools=t.tools;if(t.tool_choice)n.tool_choice=t.tool_choice;if(t.json)n.response_format={type:"json_object"};let o=await l(a,{method:"POST",headers:e,body:n,signal:t.signal});if(!o.ok||!o.body){let i=await o.text();throw new Error(`OpenRouter stream error ${o.status}: ${i}`)}for await(let i of y(o.body)){if(!i||!i.data)continue;if(i.data==="[DONE]")return;try{let m=JSON.parse(i.data),_=m.choices?.[0],h=_?.delta||{};yield{id:m.id,created:m.created,model:m.model,delta:{role:h.role,content:h.content,tool_calls:Array.isArray(h.tool_calls)?h.tool_calls.map((p)=>({id:p.id??String(p.index??0),type:"function",function:{name:p.function?.name,arguments:p.function?.arguments??""}})):void 0},finish_reason:_?.finish_reason??null,raw:m}}catch{}}}}var L="https://api.sambanova.ai/v1";function gt(t,s){let c=(t.choices??[]).map((a,e)=>({index:a.index??e,message:a.message??{role:"assistant",content:""},finish_reason:a.finish_reason??null}));return{id:t.id??"unknown",created:t.created??Math.floor(Date.now()/1000),model:t.model??"unknown",choices:c,usage:t.usage,provider:s,raw:t}}function K(t,s){return{...t||{},...s||{}}}class T{id="sambanova";name="SambaNova (OpenAI-compatible)";isGpt5(t){try{return/(^|\/)gpt-5/i.test(t)}catch{return!1}}async chat(t,s,c){let a=f(c||L,"/chat/completions"),e=K({Authorization:`Bearer ${s||""}`,"Content-Type":"application/json",Accept:"application/json"},t.extraHeaders),n={model:t.model,messages:t.messages,temperature:t.temperature,top_p:t.top_p,stream:!1};if(t.max_tokens!=null)if(this.isGpt5(t.model))n.max_completion_tokens=t.max_tokens;else n.max_tokens=t.max_tokens;if(t.tools)n.tools=t.tools;if(t.tool_choice)n.tool_choice=t.tool_choice;if(t.json)n.response_format={type:"json_object"};let o=await l(a,{method:"POST",headers:e,body:n,signal:t.signal});if(!o.ok){let m=await o.text();throw new Error(`SambaNova error ${o.status}: ${m}`)}let i=await o.json();return gt(i,this.id)}async*streamChat(t,s,c){let a=f(c||L,"/chat/completions"),e=K({Authorization:`Bearer ${s||""}`,"Content-Type":"application/json",Accept:"text/event-stream"},t.extraHeaders),n={model:t.model,messages:t.messages,temperature:t.temperature,top_p:t.top_p,stream:!0};if(t.max_tokens!=null)if(this.isGpt5(t.model))n.max_completion_tokens=t.max_tokens;else n.max_tokens=t.max_tokens;if(t.tools)n.tools=t.tools;if(t.tool_choice)n.tool_choice=t.tool_choice;if(t.json)n.response_format={type:"json_object"};let o=await l(a,{method:"POST",headers:e,body:n,signal:t.signal});if(!o.ok||!o.body){let i=await o.text();throw new Error(`SambaNova stream error ${o.status}: ${i}`)}for await(let i of y(o.body)){if(!i||!i.data)continue;if(i.data==="[DONE]")return;try{let m=JSON.parse(i.data),_=m.choices?.[0],h=_?.delta||{};yield{id:m.id,created:m.created,model:m.model,delta:{role:h.role,content:h.content,tool_calls:Array.isArray(h.tool_calls)?h.tool_calls.map((p)=>({id:p.id??String(p.index??0),type:"function",function:{name:p.function?.name,arguments:p.function?.arguments??""}})):void 0},finish_reason:_?.finish_reason??null,raw:m}}catch{}}}}var U="https://generativelanguage.googleapis.com/v1beta/openai";function yt(t,s){let c=(t.choices??[]).map((a,e)=>({index:a.index??e,message:a.message??{role:"assistant",content:""},finish_reason:a.finish_reason??null}));return{id:t.id??"unknown",created:t.created??Math.floor(Date.now()/1000),model:t.model??"unknown",choices:c,usage:t.usage,provider:s,raw:t}}function j(t,s){return{...t||{},...s||{}}}class G{id="gemini";name="Gemini (OpenAI-compatible)";isGpt5(t){try{return/(^|\/)gpt-5/i.test(t)}catch{return!1}}async chat(t,s,c){let a=f(c||U,"/chat/completions"),e=j({Authorization:`Bearer ${s||""}`,"Content-Type":"application/json",Accept:"application/json"},t.extraHeaders),n={model:t.model,messages:t.messages,temperature:t.temperature,top_p:t.top_p,stream:!1};if(t.max_tokens!=null)if(this.isGpt5(t.model))n.max_completion_tokens=t.max_tokens;else n.max_tokens=t.max_tokens;if(t.tools)n.tools=t.tools;if(t.tool_choice)n.tool_choice=t.tool_choice;if(t.json)n.response_format={type:"json_object"};let o=await l(a,{method:"POST",headers:e,body:n,signal:t.signal});if(!o.ok){let m=await o.text();throw new Error(`Gemini error ${o.status}: ${m}`)}let i=await o.json();return yt(i,this.id)}async*streamChat(t,s,c){let a=f(c||U,"/chat/completions"),e=j({Authorization:`Bearer ${s||""}`,"Content-Type":"application/json",Accept:"text/event-stream"},t.extraHeaders),n={model:t.model,messages:t.messages,temperature:t.temperature,top_p:t.top_p,stream:!0};if(t.max_tokens!=null)if(this.isGpt5(t.model))n.max_completion_tokens=t.max_tokens;else n.max_tokens=t.max_tokens;if(t.tools)n.tools=t.tools;if(t.tool_choice)n.tool_choice=t.tool_choice;if(t.json)n.response_format={type:"json_object"};let o=await l(a,{method:"POST",headers:e,body:n,signal:t.signal});if(!o.ok||!o.body){let i=await o.text();throw new Error(`Gemini stream error ${o.status}: ${i}`)}for await(let i of y(o.body)){if(!i||!i.data)continue;if(i.data==="[DONE]")return;try{let m=JSON.parse(i.data),_=m.choices?.[0],h=_?.delta||{};yield{id:m.id,created:m.created,model:m.model,delta:{role:h.role,content:h.content,tool_calls:Array.isArray(h.tool_calls)?h.tool_calls.map((p)=>({id:p.id??String(p.index??0),type:"function",function:{name:p.function?.name,arguments:p.function?.arguments??""}})):void 0},finish_reason:_?.finish_reason??null,raw:m}}catch{}}}}function kt(t){try{return typeof process!=="undefined"&&process?.env?.[t]||void 0}catch{return}}function wt(t){return kt({openai:"OPENAI_API_KEY",anthropic:"ANTHROPIC_API_KEY",groq:"GROQ_API_KEY",gemini:"GEMINI_API_KEY",openrouter:"OPENROUTER_API_KEY",sambanova:"SAMBANOVA_API_KEY"}[t])}function dt(t){switch(t){case"openai":return"https://api.openai.com/v1";case"anthropic":return"https://api.anthropic.com";default:return}}class b{registry;config;constructor(t={},s){this.config=t,this.registry=s??new R}static createDefault(t={}){let s=new b(t);return s.use(new $),s.use(new O),s.use(new E),s.use(new M),s.use(new T),s.use(new G),s}use(t){return this.registry.register(t),this}apiKeyFor(t){return this.config.apiKeys?.[t]??wt(t)}baseUrlFor(t){if(this.config.baseUrls?.[t])return this.config.baseUrls[t];if(this.config.proxy)switch(t){case"openai":return`${this.config.proxy.replace(/\/$/,"")}/openai/v1`;case"anthropic":return`${this.config.proxy.replace(/\/$/,"")}/anthropic`;default:return this.config.proxy}return dt(t)}async chat(t){let s=P(t),c=this.registry.get(s.provider);if(!c)throw new Error(`Provider not registered: ${s.provider}`);let a=this.apiKeyFor(c.id),e=this.baseUrlFor(c.id);return c.chat({...s,stream:!1},a,e)}streamChat(t){let s=P({...t,stream:!0}),c=this.registry.get(s.provider);if(!c||!c.streamChat)throw new Error(`Provider does not support streaming: ${s.provider}`);let a=this.apiKeyFor(c.id),e=this.baseUrlFor(c.id);return c.streamChat(s,a,e)}async streamToText(t){let s="";for await(let c of this.streamChat({...t,stream:!0})){let a=c.delta?.content;if(typeof a==="string")s+=a}return s}async chatWithTools(t,s,c={}){let a=c.maxCalls??10,e=[...t.messages],n=0,o=t.tool_choice;while(n<=a){let i=await this.chat({...t,messages:e,stream:!1,tool_choice:o}),_=i.choices?.[0]?.message,h=_?.tool_calls||[];if(!h.length)return i;e.push({role:"assistant",content:_?.content||"",tool_calls:h});for(let u of h){if(u.type!=="function")continue;let p=u.function?.name,x=s[p],g={};try{g=u.function?.arguments?JSON.parse(u.function.arguments):{}}catch{g={}}let k;try{if(!x)throw new Error(`No handler for tool: ${p}`);k=await x(g)}catch(r){k={error:String(r?.message||r)}}let C=typeof k==="string"?k:JSON.stringify(k);e.push({role:"tool",content:C,tool_call_id:u.id})}if(n+=1,o==="required"||o&&typeof o==="object")o="none";else o="auto"}throw new Error(`Exceeded max tool calls (${a}) during chatWithTools()`)}async*streamWithTools(t,s,c={}){let a=c.maxCalls??10,e={...t,stream:!0},n=[...t.messages],o=0,i=t.tool_choice;while(o<=a){let m=this.streamChat({...e,messages:n,tool_choice:i}),_=new Map;for await(let u of m){let p=u.delta?.tool_calls||[];for(let x of p){if(!x)continue;let g=x.id||"0",k=_.get(g)??{name:x.function?.name,args:""};if(x.function?.name)k.name=x.function.name;if(x.function?.arguments)k.args+=x.function.arguments;_.set(g,k)}yield u}if(_.size===0)return;let h=Array.from(_.entries()).filter(([,u])=>u.name&&u.name.length>0).map(([u,p])=>({id:u,type:"function",function:{name:p.name,arguments:p.args||"{}"}}));if(h.length===0)return;n.push({role:"assistant",content:"",tool_calls:h});for(let u of h){let p=s[u.function.name],x={};try{x=u.function.arguments?JSON.parse(u.function.arguments):{}}catch{x={}}let g;try{if(!p)throw new Error(`No handler for tool: ${u.function.name}`);g=await p(x)}catch(C){g={error:String(C?.message||C)}}let k=typeof g==="string"?g:JSON.stringify(g);n.push({role:"tool",content:k,tool_call_id:u.id})}if(o+=1,i==="required"||i&&typeof i==="object")i="none";else i="auto"}throw new Error(`Exceeded max tool calls (${a}) during streamWithTools()`)}}export{P as validateChatRequest,T as SambaNovaProvider,R as ProviderRegistry,M as OpenRouterProvider,$ as OpenAIProvider,b as HRI,E as GroqProvider,G as GeminiProvider,O as AnthropicProvider};

//# debugId=7C32D889D9CE69EB64756E2164756E21
//# sourceMappingURL=index.js.map
